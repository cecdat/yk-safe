# YK-Safe 防火墙管理系统 - 更新日志

## [2024-12-19] - 资源监控 API 重构优化

### 重构内容
- **API 统一化**: 将所有资源监控功能统一为 API 形式，移除混合调用方式
- **职责分离**: 将监控相关 API 从 `firewall.js` 移至 `monitor.js`，保持职责清晰
- **性能优化**: 新增综合仪表盘 API `/api/monitor/dashboard`，一次性返回所有监控数据
- **代码优化**: 重构 Dashboard.jsx 使用统一的 API 调用方式，提高代码可维护性

### 技术细节
- **新增 API 端点**: `/api/monitor/dashboard` - 综合仪表盘数据接口
- **API 重构**: 
  - 移除 `firewall.js` 中的监控相关 API
  - 完善 `monitor.js` 中的 API 定义
  - 统一使用 axios 实例和拦截器
- **前端优化**:
  - Dashboard.jsx 优先使用综合 API，失败时回退到多个 API 调用
  - 移除直接 `fetch()` 调用，统一使用 API 函数
  - 提高数据获取性能和用户体验

### 性能提升
- **减少网络请求**: 从 5 个独立 API 调用减少到 1 个综合 API 调用
- **降低延迟**: 减少网络往返时间，提高页面响应速度
- **更好的错误处理**: 统一的错误处理和重试机制

---

## [2024-12-19] - 修复 OpenAPI 文档访问问题

### 修复内容
- **OpenAPI 文档修复**: 修复了 `/docs` 接口文档访问报错 "Unable to render this definition" 的问题
- **FastAPI 配置优化**: 
  - 添加了完整的 OpenAPI 3.0.2 规范配置
  - 移除了未使用的 `StaticFiles` 导入
  - 添加了详细的 API 描述文档
  - 配置了服务器信息（本地开发和生产环境）
- **API 文档增强**:
  - 为根路径和健康检查接口添加了标签和描述
  - 提供了更完整的 API 功能说明

### 技术细节
- 修复了 FastAPI 应用配置中的 OpenAPI 版本字段问题
- 确保所有路由都有正确的标签分类
- 添加了服务器配置以支持不同环境的 API 文档

---

## [2024-12-19] - 核弹级问题修复：白名单模式规则顺序

### 修复内容
- **规则顺序修复**: 解决了白名单模式下新增IP位置在drop规则之后导致无法访问的问题
- **动态位置检测**: 新增 `_get_drop_rule_position()` 方法动态查找drop规则位置
- **智能规则插入**: 修改 `_build_nft_add_command()` 在白名单模式下将accept规则插入到drop规则之前
- **完整同步支持**: 更新 `sync_rules_from_db()` 确保全量同步时也遵循正确的规则顺序

### 技术细节
- 在 `nftables_generator.py` 中添加了规则位置检测逻辑
- 实现了白名单模式下的智能规则排序
- 提供了测试脚本 `test-whitelist-fix.sh` 用于验证修复效果

---

## [2024-12-19] - 页面顶部 Header 样式统一

### 修复内容
- **Header 样式统一**: 重构了 `AppLayout.jsx` Header 和 `FirewallModeSwitch.jsx` 组件
- **Ant Design 组件化**: 完全使用 Ant Design 组件构建 Header
- **弹出页面透明度修复**: 修复了所有弹出页面（Modals、dropdowns、tooltips、messages）变成透明的问题

### 技术细节
- 使用 `Space`、`Avatar`、`Typography`、`Tag`、`Button` 等 Ant Design 组件
- 添加了 `!important` CSS 规则强制白色背景和黑色文字
- 优化了防火墙控制区域的布局和样式

---

## [2024-12-19] - 白名单模式规则转换修复

### 修复内容
- **模式切换规则转换**: 修复了从白名单切换到黑名单模式时，原有白名单IP变成拒绝连接的问题
- **自动规则转换**: 添加了 `convert_rules_for_mode_switch()` 函数自动更新数据库中的规则动作

### 技术细节
- 在 `firewall.py` 中实现了规则动作的自动转换逻辑
- 白名单模式切换为黑名单时，所有规则动作变为 `drop`
- 黑名单模式切换为白名单时，所有规则动作变为 `accept`

---

## [2024-12-19] - Ping 和路由跟踪结果持久化

### 修复内容
- **结果持久化**: 修复了 Ping 和路由跟踪结果"阅后即焚"的问题
- **状态管理优化**: 实现了稳定的命令结果状态管理
- **生命周期优化**: 优化了组件生命周期和清理逻辑

### 技术细节
- 引入了 `commandResults` 状态来稳定存储命令输出
- 优化了 `pollCommandOutput` 逻辑，防止重复执行
- 确保结果在页面切换、刷新等操作后仍然保持

---

## [2024-12-19] - 网络工具功能完善

### 修复内容
- **tcpdump 抓包工具**: 修复了抓包时长不生效、文件生成失败等问题
- **ping 和 traceroute**: 修复了实时输出、停止功能等问题
- **网络接口检测**: 修复了网卡信息显示错误的问题

### 技术细节
- 重构了 `network.py` 中的抓包逻辑，使用非阻塞执行
- 修复了网络接口检测，使用 `psutil` 准确识别物理接口
- 优化了前端状态管理和用户界面

---

## [2024-12-19] - 现代化科技感主题

### 新增内容
- **主题升级**: 将整体设计升级为"现代化科技感主题"
- **全局样式**: 定义了全局 CSS 变量和 Ant Design 主题配置
- **组件优化**: 优化了开关、徽章、卡片等组件的视觉效果

### 技术细节
- 使用 Google Fonts (Inter) 作为主要字体
- 配置了 Ant Design `ConfigProvider` 的主题定制
- 实现了统一的颜色方案和视觉风格

---

## [2024-12-19] - 系统设置功能

### 新增内容
- **密码修改**: 支持用户密码修改功能
- **数据备份**: 支持系统数据备份、导入、下载、删除
- **推送设置**: 支持 webhooks、Bark 等多种推送渠道

### 技术细节
- 修复了密码验证的加密算法不一致问题
- 实现了完整的备份文件管理功能
- 添加了多种推送渠道的配置支持

---

## [2024-12-19] - 网络工具集成

### 新增内容
- **tcpdump**: 网络抓包工具，支持协议、接口、IP过滤
- **ping**: 网络连通性测试工具
- **traceroute**: 路由追踪工具

### 技术细节
- 实现了实时命令输出和进度显示
- 支持文件压缩和下载功能
- 提供了历史记录管理功能

---

## [2024-12-19] - 防火墙规则管理重构

### 重构内容
- **规则逻辑重构**: 支持"允许"和"拒绝"规则选择
- **搜索和筛选**: 添加了规则名称和备注搜索功能
- **模式切换**: 实现了黑名单/白名单模式切换
- **重复IP检测**: 防止添加重复IP地址

### 技术细节
- 重构了规则管理的数据模型和业务逻辑
- 实现了动态的 nftables 配置生成
- 添加了完整的规则验证和错误处理

---

## [2024-12-19] - 部署脚本优化

### 优化内容
- **脚本合并**: 将 `deploy-safe.sh` 和 `deploy.sh` 合并为单一部署脚本
- **错误修复**: 修复了部署过程中的语法错误
- **Docker 支持**: 优化了 Docker 环境的网络配置

### 技术细节
- 统一了部署流程和配置管理
- 添加了更完善的错误处理和日志输出
- 优化了系统依赖安装和配置步骤