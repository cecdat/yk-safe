# YK-Safe æ›´æ–°æ—¥å¿— (CHANGELOG)

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ›´æ–°è®°å½•](#æ›´æ–°è®°å½•)
  - [é˜²ç«å¢™æ¶æ„é‡æ„](#é˜²ç«å¢™æ¶æ„é‡æ„)
  - [Dockerå®¹å™¨ç›‘æ§ä¼˜åŒ–](#dockerå®¹å™¨ç›‘æ§ä¼˜åŒ–)
  - [Dashboardç•Œé¢ä¼˜åŒ–](#dashboardç•Œé¢ä¼˜åŒ–)
  - [IPåœ°å€è·å–å’ŒéªŒè¯ä¿®å¤](#ipåœ°å€è·å–å’ŒéªŒè¯ä¿®å¤)
  - [é˜²ç«å¢™æ—¥å¿—ç³»ç»Ÿ](#é˜²ç«å¢™æ—¥å¿—ç³»ç»Ÿ)
  - [Tokenç®¡ç†æ¨¡å—](#tokenç®¡ç†æ¨¡å—)
  - [GeoIPé›†æˆ](#geoipé›†æˆ)
  - [ç™½åå•ç”³è¯·é¡µé¢ä¼˜åŒ–](#ç™½åå•ç”³è¯·é¡µé¢ä¼˜åŒ–)
  - [é”™è¯¯å¤„ç†æ”¹è¿›](#é”™è¯¯å¤„ç†æ”¹è¿›)
  - [å‰ç«¯æ„å»ºä¿®å¤](#å‰ç«¯æ„å»ºä¿®å¤)
  - [éƒ¨ç½²è„šæœ¬ä¼˜åŒ–](#éƒ¨ç½²è„šæœ¬ä¼˜åŒ–)
- [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)
- [æŠ€æœ¯æ”¯æŒ](#æŠ€æœ¯æ”¯æŒ)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

YK-Safe æ˜¯ä¸€ä¸ªä¸“ä¸º Debian/Ubuntu ç³»ç»Ÿè®¾è®¡çš„ç°ä»£åŒ–é˜²ç«å¢™ç®¡ç†ç³»ç»Ÿï¼ŒåŸºäº FastAPI + React æ„å»ºã€‚ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„é˜²ç«å¢™è§„åˆ™ç®¡ç†ã€ç³»ç»Ÿç›‘æ§ã€ç™½åå•ç”³è¯·ã€Tokenç®¡ç†ç­‰åŠŸèƒ½ã€‚

## âœ… æ ¸å¿ƒåŠŸèƒ½

### **é˜²ç«å¢™ç®¡ç†**
- æ”¯æŒé»‘åå•/ç™½åå•æ¨¡å¼åˆ‡æ¢
- Rawè¡¨æ¶æ„ - é»‘åå•è§„åˆ™æœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œ
- åŒå±‚æ¶æ„ - å®æ—¶æ“ä½œ + æŒä¹…åŒ–é…ç½®
- è¿æ¥çŠ¶æ€ç®¡ç† - å®æ—¶è¸¢ä¸‹çº¿åŠŸèƒ½

### **ç³»ç»ŸåŠŸèƒ½**
- ç³»ç»Ÿç›‘æ§å’Œæ—¥å¿—ç®¡ç†
- ç‹¬ç«‹çš„ç™½åå•ç”³è¯·é¡µé¢
- è‡ªåŠ¨IPæ£€æµ‹å’Œä»£ç†è­¦å‘Š
- Tokenç®¡ç†å’Œç”³è¯·å®¡æ ¸
- Dockerç½‘ç»œç¯å¢ƒå®Œå…¨å…¼å®¹
- å®æ—¶è§„åˆ™åŒæ­¥æœåŠ¡

## ğŸ› ï¸ æŠ€æœ¯æ¶æ„

### **åç«¯**
- FastAPI (Python Webæ¡†æ¶)
- SQLAlchemy (ORM)
- nftables (é˜²ç«å¢™ç®¡ç†)
- conntrack-tools (è¿æ¥çŠ¶æ€ç®¡ç†)
- psutil (ç³»ç»Ÿç›‘æ§)

### **å‰ç«¯**
- React 18
- Ant Design
- ECharts (æ•°æ®å¯è§†åŒ–)

### **éƒ¨ç½²**
- systemd (æœåŠ¡ç®¡ç†)
- Nginx (åå‘ä»£ç†)
- apt-get (åŒ…ç®¡ç†)

---

## ğŸ“ æ›´æ–°è®°å½•

### ğŸ”¥ é˜²ç«å¢™æ¶æ„é‡æ„ (2024å¹´8æœˆ)

#### **é—®é¢˜æè¿°**
åŸæœ‰çš„ `nftables` é…ç½®ä½¿ç”¨ `flush ruleset` å¯¼è‡´ç½‘ç»œ disruptionsï¼Œæ¸…é™¤äº† Docker çš„ç½‘ç»œè§„åˆ™ï¼Œé€ æˆ"æ ¸å¼¹çº§é—®é¢˜"ã€‚

#### **è§£å†³æ–¹æ¡ˆ**
1. **æ¶ˆé™¤ `flush ruleset`**: åœæ­¢æ¸…ç©ºæ•´ä¸ª `nftables` è§„åˆ™é›†
2. **ä¸“ç”¨åº”ç”¨é“¾**: åˆ›å»ºä¸“é—¨çš„ `nftables` é“¾ (`YK_SAFE_CHAIN`) åœ¨ `filter` è¡¨ä¸­
3. **è·³è½¬è§„åˆ™**: åœ¨ `filter` è¡¨çš„ `input` é“¾ä¸­æ’å…¥ `jump` è§„åˆ™é‡å®šå‘åˆ° `YK_SAFE_CHAIN`
4. **éƒ¨ç½²è„šæœ¬é›†æˆ**: ä¿®æ”¹ `deploy.sh` æ‰§è¡Œä¸€æ¬¡æ€§åˆ›å»ºä¸“ç”¨é“¾å’Œè·³è½¬è§„åˆ™

#### **æŠ€æœ¯å®ç°**
- **`nftables_generator.py` é‡æ„**:
  - ç§»é™¤æ‰€æœ‰ `flush ruleset` å’Œ `/etc/nftables.conf` å†™å…¥é€»è¾‘
  - ä¿®æ”¹ `add_rule_realtime` ç›´æ¥æ·»åŠ è§„åˆ™åˆ° `YK_SAFE_CHAIN`
  - ä¿®æ”¹ `delete_rule_realtime` ç›´æ¥ä» `YK_SAFE_CHAIN` åˆ é™¤è§„åˆ™
  - å¼•å…¥æ–°çš„ `sync_rules_from_db` æ–¹æ³•æ›¿æ¢ `apply_config`
- **é˜²ç«å¢™APIæ›´æ–°**: è°ƒæ•´åç«¯APIä½¿ç”¨æ–°çš„ `sync_rules_from_db` æ–¹æ³•

#### **æ–‡ä»¶ä¿®æ”¹**
- `deploy.sh`: æ·»åŠ  `jump YK_SAFE_CHAIN` è§„åˆ™å’Œ `YK_SAFE_CHAIN` å®šä¹‰
- `nftables_generator.py`: é‡æ„æ ¸å¿ƒé€»è¾‘ï¼Œç§»é™¤ `flush ruleset`
- `firewall.py`: ä¿®æ”¹ `reload_nftables` è°ƒç”¨ `generator.sync_rules_from_db()`

---

### ğŸ³ Dockerå®¹å™¨ç›‘æ§ä¼˜åŒ– (2024å¹´8æœˆ)

#### **é—®é¢˜æè¿°**
åŸæœ‰çš„ `get_container_info` å®ç°ä½¿ç”¨ `subprocess.run` è°ƒç”¨ `docker` å‘½ä»¤ï¼Œæ•ˆç‡ä½ä¸‹ä¸”ä¸ä¸€è‡´ã€‚

#### **è§£å†³æ–¹æ¡ˆ**
ä½¿ç”¨å®˜æ–¹ `Docker SDK for Python` æ›¿æ¢ `subprocess.run` å®ç°ã€‚

#### **æŠ€æœ¯å®ç°**
```python
import docker

def get_container_info():
    client = docker.from_env()
    containers = client.containers.list()
    
    container_info = []
    for container in containers:
        info = {
            'name': container.name,
            'status': container.status,
            'image': container.image.tags[0] if container.image.tags else container.image.id,
            'ports': container.ports,
            'mounts': container.attrs.get('Mounts', []),
            'short_id': container.short_id,
            'created': container.attrs.get('Created', '')
        }
        
        # åªä¸ºè¿è¡Œä¸­çš„å®¹å™¨è·å–å®æ—¶ç»Ÿè®¡
        if container.status == 'running':
            try:
                stats = container.stats(stream=False)
                info['stats'] = stats
            except Exception as e:
                info['stats'] = None
        
        container_info.append(info)
    
    return container_info
```

#### **ä¼˜åŒ–ç‰¹æ€§**
- **ç«¯å£æ˜ å°„è§£æ**: æ”¹è¿› `container.ports` è§£æï¼Œæ ¼å¼åŒ–ä¸º `HostIp:HostPort->ContainerPort`
- **æŒ‚è½½ä¿¡æ¯è·å–**: ä» `container.attrs` (é«˜çº§API) è·å–æŒ‚è½½ä¿¡æ¯ï¼Œæé«˜ä¸€è‡´æ€§å’Œæ•ˆç‡
- **æŒ‚è½½æ ¼å¼**: å°†åŸå§‹æŒ‚è½½å­—å…¸æ ¼å¼åŒ–ä¸ºå¯è¯»å­—ç¬¦ä¸²åˆ—è¡¨
- **æ¡ä»¶ç»Ÿè®¡**: åªä¸º `running` çŠ¶æ€çš„å®¹å™¨è·å–å®æ—¶ç»Ÿè®¡

---

### ğŸ¨ Dashboardç•Œé¢ä¼˜åŒ– (2024å¹´8æœˆ)

#### **ç§»é™¤åŠŸèƒ½**
- åˆ é™¤"ç£ç›˜ä½¿ç”¨æƒ…å†µ"å¡ç‰‡
- åˆ é™¤"æœ€è¿‘ç³»ç»Ÿæ—¥å¿—"å¡ç‰‡

#### **ç³»ç»Ÿè´Ÿè½½å¡ç‰‡å¢å¼º**
- æ·»åŠ ç£ç›˜ä½¿ç”¨ä¿¡æ¯ï¼Œæ”¯æŒå¤šç£ç›˜æ˜¾ç¤º
- ç³»ç»Ÿè´Ÿè½½è¶…è¿‡1.5å€CPUæ ¸å¿ƒæ•°æ—¶æ˜¾ç¤ºé»„è‰²è­¦å‘Šå¾½ç« 
- ç³»ç»Ÿè´Ÿè½½è¶…è¿‡2.5å€CPUæ ¸å¿ƒæ•°æ—¶æ˜¾ç¤ºçº¢è‰²è­¦å‘Šå¾½ç« 

#### **ç£ç›˜ä½¿ç”¨æ˜¾ç¤ºä¼˜åŒ–**
- ç£ç›˜ä½¿ç”¨è¶…è¿‡80%æ—¶æ˜¾ç¤ºé»„è‰²è­¦å‘Šå¾½ç« 
- ç£ç›˜ä½¿ç”¨è¶…è¿‡95%æ—¶æ˜¾ç¤ºçº¢è‰²è­¦å‘Šå¾½ç« 
- æ•°å€¼æ˜¾ç¤ºä¿ç•™2ä½å°æ•°

#### **CPUä½¿ç”¨ç‡å¡ç‰‡å¢å¼º**
- æ˜¾ç¤ºCPUæ ¸å¿ƒæ•°é‡
- ä»¥ç¾è§‚æ–¹å¼æ˜¾ç¤ºæ‰€æœ‰æ ¸å¿ƒçš„ä½¿ç”¨ç‡

#### **Dockerå®¹å™¨ç›‘æ§å¡ç‰‡å¢å¼º**
- æ˜¾ç¤ºç«¯å£æ˜ å°„ï¼ˆä¹‹å‰æœªæ˜¾ç¤ºï¼‰
- æ˜¾ç¤ºè·¯å¾„æ˜ å°„ï¼ˆå·ï¼‰ï¼Œæ’é™¤æ—¶åŒºæ˜ å°„

#### **é˜²ç«å¢™çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–**
- é˜²ç«å¢™çŠ¶æ€ä½¿ç”¨å¾½ç« æ˜¾ç¤ºï¼ˆç»¿è‰²è¿è¡Œã€çº¢è‰²åœæ­¢ã€é»„è‰²æœªçŸ¥ï¼‰
- é˜²ç«å¢™æ¨¡å¼ä½¿ç”¨é»‘ç™½æ–‡æœ¬æ˜¾ç¤º
- å°†é˜²ç«å¢™çŠ¶æ€å’Œæ¨¡å¼æ˜¾ç¤ºä»"ç³»ç»Ÿæ¦‚è§ˆ"ç§»åŠ¨åˆ°é¡µé¢é¡¶éƒ¨æ ‡é¢˜æ å·¦ä¾§

---

### ğŸŒ IPåœ°å€è·å–å’ŒéªŒè¯ä¿®å¤ (2024å¹´12æœˆ)

#### **å…³é”®é—®é¢˜åˆ†æ**
1. **APIç«¯ç‚¹è°ƒç”¨é”™è¯¯**: `detectNetworkEnvironment` å‡½æ•°è°ƒç”¨ `${API_BASE}/public/ip` è¿”å›æœåŠ¡å™¨IPè€Œéè®¿å®¢çœŸå®IP
2. **IPè¾“å…¥æ¡†åªè¯»çŠ¶æ€ç®¡ç†**: APIè°ƒç”¨å¤±è´¥æ—¶è¾“å…¥æ¡†ä¿æŒ `readonly` çŠ¶æ€ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨è¾“å…¥
3. **IPæ ¼å¼éªŒè¯ç¼ºå¤±**: ç¼ºä¹å¯¹è¾“å…¥IPåœ°å€çš„æ ¼å¼éªŒè¯å’Œç§æœ‰IPæ£€æµ‹

#### **ä¿®å¤æ–¹æ¡ˆ**
1. **å¤šé‡IPè·å–ç­–ç•¥**:
   - ç¬¬ä¸‰æ–¹æœåŠ¡ä¼˜å…ˆï¼ˆå¦‚ `api.ipify.org`ï¼‰
   - åç«¯APIå¤‡ç”¨
   - å®Œå–„çš„é”™è¯¯å¤„ç†

2. **å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†**:
   - ç¡®ä¿ä»»ä½•é”™è¯¯æƒ…å†µä¸‹è¾“å…¥æ¡†éƒ½æ˜¯å¯ç¼–è¾‘çš„
   - æä¾›æ¸…æ™°çš„ç”¨æˆ·æç¤º
   - ä¸é˜»å¡ç”¨æˆ·æ“ä½œ

3. **å¢å¼ºçš„IPåœ°å€éªŒè¯**:
   - å®æ—¶æ ¼å¼éªŒè¯
   - ç§æœ‰IPåœ°å€æ£€æµ‹
   - å…¬ç½‘IPåœ°å€ç¡®è®¤
   - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

#### **æŠ€æœ¯å®ç°**
```javascript
// å¤šé‡IPè·å–ç­–ç•¥
try {
    const thirdPartyResponse = await fetch('https://api.ipify.org?format=json', {
        method: 'GET',
        signal: AbortSignal.timeout(5000)
    });
    
    if (thirdPartyResponse.ok) {
        const thirdPartyData = await thirdPartyResponse.json();
        publicIp = thirdPartyData.ip;
        ipSource = 'ç¬¬ä¸‰æ–¹æœåŠ¡';
    }
} catch (thirdPartyError) {
    console.log('ç¬¬ä¸‰æ–¹æœåŠ¡è·å–IPå¤±è´¥:', thirdPartyError.message);
}

// åç«¯APIå¤‡ç”¨
if (!publicIp) {
    try {
        const ipResponse = await fetch(`${API_BASE}/public/ip`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            signal: AbortSignal.timeout(8000)
        });
        
        if (ipResponse.ok) {
            const ipData = await ipResponse.json();
            publicIp = ipData.ip;
            ipSource = 'åç«¯API';
        }
    } catch (backendError) {
        console.log('åç«¯APIè·å–IPå¤±è´¥:', backendError.message);
    }
}
```

#### **IPéªŒè¯åŠŸèƒ½**
```javascript
// IPåœ°å€æ ¼å¼éªŒè¯
function isValidIP(ip) {
    if (!ip || typeof ip !== 'string') {
        return false;
    }
    
    const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return ipPattern.test(ip.trim());
}

// ç§æœ‰IPåœ°å€æ£€æµ‹
function isPrivateIP(ip) {
    if (!isValidIP(ip)) {
        return false;
    }
    
    const parts = ip.split('.').map(Number);
    const first = parts[0];
    const second = parts[1];
    
    return (
        (first === 10) ||                                    // 10.x.x.x
        (first === 172 && second >= 16 && second <= 31) ||   // 172.16-31.x.x
        (first === 192 && second === 168) ||                 // 192.168.x.x
        (first === 127) ||                                   // 127.x.x.x (æœ¬åœ°å›ç¯)
        (first === 169 && second === 254) ||                 // 169.254.x.x (é“¾è·¯æœ¬åœ°)
        (first === 0)                                        // 0.x.x.x
    );
}
```

---

### ğŸ“Š é˜²ç«å¢™æ—¥å¿—ç³»ç»Ÿ (2024å¹´8æœˆ)

#### **åŠŸèƒ½ç‰¹æ€§**
- **è¯¦ç»†æ—¥å¿—è®°å½•**: è¿æ¥ä¿¡æ¯ã€åŠ¨ä½œè®°å½•ã€è§„åˆ™å…³è”ã€ç½‘ç»œç»†èŠ‚ã€åœ°ç†ä½ç½®ã€å¨èƒè¯„ä¼°
- **æ™ºèƒ½å¨èƒè¯„ä¼°**: ç«¯å£é£é™©ã€åè®®åˆ†æã€åŠ¨ä½œæƒé‡ã€åœ°ç†ä½ç½®é£é™©è¯„ä¼°
- **é«˜æ€§èƒ½è®¾è®¡**: å¼‚æ­¥å¤„ç†ã€æ‰¹é‡æ’å…¥ã€é˜Ÿåˆ—ç¼“å†²ã€ç´¢å¼•ä¼˜åŒ–
- **ç»Ÿè®¡åˆ†æ**: å®æ—¶ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æã€çƒ­é—¨IPã€åŠ¨ä½œåˆ†å¸ƒ
- **ç®¡ç†åŠŸèƒ½**: çµæ´»æŸ¥è¯¢ã€åˆ†é¡µæ”¯æŒã€æ—¥å¿—å¯¼å‡ºã€è‡ªåŠ¨æ¸…ç†

#### **ç³»ç»Ÿæ¶æ„**
```sql
CREATE TABLE firewall_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_ip TEXT,                    -- æºIPåœ°å€
    destination_ip TEXT,               -- ç›®æ ‡IPåœ°å€
    protocol TEXT,                     -- åè®®ç±»å‹
    source_port INTEGER,               -- æºç«¯å£
    destination_port INTEGER,          -- ç›®æ ‡ç«¯å£
    action TEXT,                       -- é˜²ç«å¢™åŠ¨ä½œ
    rule_id INTEGER,                   -- å…³è”è§„åˆ™ID
    rule_name TEXT,                    -- è§„åˆ™åç§°
    interface TEXT,                    -- ç½‘ç»œæ¥å£
    packet_size INTEGER,               -- æ•°æ®åŒ…å¤§å°
    tcp_flags TEXT,                    -- TCPæ ‡å¿—
    country TEXT,                      -- æºIPå›½å®¶
    city TEXT,                         -- æºIPåŸå¸‚
    isp TEXT,                          -- ç½‘ç»œæœåŠ¡å•†
    threat_level TEXT,                 -- å¨èƒç­‰çº§
    description TEXT,                  -- è¯¦ç»†æè¿°
    timestamp DATETIME                 -- æ—¶é—´æˆ³
);
```

#### **æ ¸å¿ƒç»„ä»¶**
1. **FirewallLogger**: æ—¥å¿—è®°å½•å™¨æ ¸å¿ƒç±»
2. **æ—¥å¿—é˜Ÿåˆ—**: å†…å­˜ç¼“å†²é˜Ÿåˆ—
3. **å·¥ä½œçº¿ç¨‹**: å¼‚æ­¥æ—¥å¿—å¤„ç†
4. **åœ°ç†ä½ç½®æœåŠ¡**: IPåœ°ç†ä½ç½®æŸ¥è¯¢
5. **å¨èƒè¯„ä¼°å¼•æ“**: è‡ªåŠ¨å¨èƒç­‰çº§è®¡ç®—

#### **APIæ¥å£**
- `GET /api/logs/firewall` - è·å–é˜²ç«å¢™æ—¥å¿—
- `GET /api/logs/stats` - è·å–æ—¥å¿—ç»Ÿè®¡
- `GET /api/logs/firewall/summary` - è·å–æ—¥å¿—æ‘˜è¦
- `GET /api/logs/firewall/export` - å¯¼å‡ºæ—¥å¿—
- `POST /api/logs/firewall/cleanup` - æ¸…ç†æ—§æ—¥å¿—

---

### ğŸ”‘ Tokenç®¡ç†æ¨¡å— (2024å¹´8æœˆ)

#### **æ ¸å¿ƒåŠŸèƒ½**
1. **Tokenç®¡ç†**: åˆ›å»ºã€é…ç½®ã€çŠ¶æ€ç®¡ç†ã€å®‰å…¨æ“ä½œ
2. **TokenéªŒè¯**: æ ¼å¼éªŒè¯ã€çŠ¶æ€æ£€æŸ¥ã€å®‰å…¨éªŒè¯
3. **ä½¿ç”¨ç»Ÿè®¡**: ä½¿ç”¨æƒ…å†µã€è¯·æ±‚ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æ
4. **å®¡è®¡æ—¥å¿—**: æ“ä½œè®°å½•ã€ç”¨æˆ·è¿½è¸ªã€æ—¥å¿—å¯¼å‡º

#### **åç«¯API**
- **Tokenç®¡ç†API** (`/api/tokens/`): åˆ›å»ºã€æ‰¹é‡åˆ›å»ºã€è·å–ã€æ›´æ–°ã€åˆ é™¤ã€æ¿€æ´»/åœç”¨ã€é‡æ–°ç”Ÿæˆã€ä½¿ç”¨æƒ…å†µã€ç»Ÿè®¡æ¦‚è§ˆ
- **Tokenå®¡è®¡API** (`/api/token-audit/`): å®¡è®¡æ—¥å¿—ã€æ“ä½œç»Ÿè®¡ã€å¯¼å‡ºã€æ¸…ç†ã€æœ€è¿‘æ—¥å¿—

#### **æ•°æ®åº“æ¨¡å‹**
```sql
CREATE TABLE whitelist_tokens (
    id INTEGER PRIMARY KEY,
    token VARCHAR UNIQUE NOT NULL,
    company_name VARCHAR NOT NULL,
    description TEXT,
    max_uses INTEGER DEFAULT 100,
    used_count INTEGER DEFAULT 0,
    expires_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    auto_approve BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR,
    updated_at DATETIME
);
```

#### **å·¥å…·å‡½æ•°**
- `generate_secure_token()` - ç”Ÿæˆå®‰å…¨çš„éšæœºToken
- `validate_token_format()` - éªŒè¯Tokenæ ¼å¼
- `verify_token()` - éªŒè¯Tokenæœ‰æ•ˆæ€§
- `increment_token_usage()` - å¢åŠ Tokenä½¿ç”¨æ¬¡æ•°
- `log_token_action()` - è®°å½•Tokenæ“ä½œæ—¥å¿—

---

### ğŸŒ GeoIPé›†æˆ (2024å¹´8æœˆ)

#### **ä¸»è¦æ”¹è¿›**
1. **GeoIPæ•°æ®åº“é›†æˆ**: é›†æˆGeoLite2-City.mmdbæ•°æ®åº“
2. **åç«¯APIæ”¹è¿›**: æ–°å¢ç½‘ç»œè¿æ¥ç›‘æ§APIç«¯ç‚¹
3. **å‰ç«¯ç•Œé¢æ”¹è¿›**: ç½‘ç»œè¿æ¥å¼¹çª—æ‰©å±•ï¼Œåœ°ç†ä½ç½®æ˜¾ç¤º
4. **GeoIPå·¥å…·ç±»**: GeoIPManagerç±»å’Œä¾¿æ·å‡½æ•°

#### **æ–°å¢APIç«¯ç‚¹**
1. **`GET /api/monitor/connections`**: è·å–è¯¦ç»†çš„ç½‘ç»œè¿æ¥ä¿¡æ¯ï¼ŒåŒ…å«IPåœ°ç†ä½ç½®
2. **`GET /api/monitor/connections/{ip}`**: è·å–ç‰¹å®šIPåœ°å€çš„è¿æ¥è¯¦æƒ…

#### **åŠŸèƒ½ç‰¹æ€§**
- **IPåˆ†ç»„ç»Ÿè®¡**: æŒ‰è¿œç¨‹IPåœ°å€åˆ†ç»„ç»Ÿè®¡è¿æ¥æ•°
- **åœ°ç†ä½ç½®æŸ¥è¯¢**: è‡ªåŠ¨æŸ¥è¯¢IPåœ°å€çš„åœ°ç†ä½ç½®ä¿¡æ¯
- **æœ¬åœ°IPè¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æœ¬åœ°ç½‘ç»œå’Œç§æœ‰IPåœ°å€
- **è¿æ¥çŠ¶æ€ç»Ÿè®¡**: ç»Ÿè®¡TCP/UDPè¿æ¥çŠ¶æ€åˆ†å¸ƒ

#### **GeoIPå·¥å…·ç±»**
```python
class GeoIPManager:
    - get_ip_info(ip_address): è·å–è¯¦ç»†åœ°ç†ä½ç½®ä¿¡æ¯
    - get_simple_ip_info(ip_address): è·å–ç®€åŒ–åœ°ç†ä½ç½®ä¿¡æ¯
    - get_ip_summary(ip_address): è·å–åœ°ç†ä½ç½®æ‘˜è¦
```

#### **ä¾¿æ·å‡½æ•°**
```python
- get_ip_location(ip_address): è·å–è¯¦ç»†åœ°ç†ä½ç½®ä¿¡æ¯
- get_ip_location_simple(ip_address): è·å–ç®€åŒ–åœ°ç†ä½ç½®ä¿¡æ¯
- get_ip_location_summary(ip_address): è·å–åœ°ç†ä½ç½®æ‘˜è¦
```

---

### ğŸ“ ç™½åå•ç”³è¯·é¡µé¢ä¼˜åŒ– (2024å¹´8æœˆ)

#### **Tokenæ¨¡å—é›†æˆ**
- **åç«¯æ”¹è¿›**: æ›´æ–° `whitelist.py` APIï¼Œé›†æˆæ–°çš„tokenç›¸å…³schemaså’Œå·¥å…·å‡½æ•°
- **å‰ç«¯æ”¹è¿›**: æ”¹è¿›tokenéªŒè¯æµç¨‹ï¼Œæ·»åŠ è¯¦ç»†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

#### **IPè·å–åŠŸèƒ½ä¼˜åŒ–**
- **åç«¯æ”¹è¿›**: ä¼˜åŒ– `ip_utils.py`ï¼Œå‡å°‘å¤–éƒ¨æœåŠ¡è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œæ·»åŠ IPæœ‰æ•ˆæ€§éªŒè¯
- **å‰ç«¯æ”¹è¿›**: æ”¹è¿›IPè·å–æµç¨‹ï¼Œæ·»åŠ è¯·æ±‚è¶…æ—¶å¤„ç†ï¼Œæ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

#### **è¡¨å•æäº¤ä¼˜åŒ–**
- **æ•°æ®éªŒè¯**: æ·»åŠ åŸºæœ¬å­—æ®µéªŒè¯ï¼Œä½¿ç”¨ `trim()` å»é™¤è¾“å…¥å­—æ®µçš„é¦–å°¾ç©ºæ ¼
- **é”™è¯¯å¤„ç†**: æ·»åŠ è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†ï¼Œæ”¹è¿›é”™è¯¯æç¤ºä¿¡æ¯çš„å¯è¯»æ€§
- **ç”¨æˆ·ä½“éªŒ**: ä¿æŒIPåœ°å€å­—æ®µçš„å€¼ï¼Œæä¾›æ›´è¯¦ç»†çš„æ“ä½œåé¦ˆä¿¡æ¯

#### **IPä½ç½®ä¿¡æ¯åŠŸèƒ½**
- **è§†è§‰è®¾è®¡**: ä¼˜é›…çš„æ¸å˜èƒŒæ™¯ã€åœ†è§’è¾¹æ¡†ã€åŠ¨ç”»æ•ˆæœã€å“åº”å¼å¸ƒå±€
- **ä¿¡æ¯å±•ç¤º**: å›½å®¶/åœ°åŒºã€åŸå¸‚ã€åœ°åŒºã€æ—¶åŒºä¿¡æ¯ï¼Œæ”¯æŒå›½æ——emojiæ˜¾ç¤º
- **äº¤äº’ä½“éªŒ**: è‡ªåŠ¨è·å–ã€å®æ—¶æ›´æ–°ã€åŠ è½½çŠ¶æ€ã€æ‰‹åŠ¨è¾“å…¥ã€å®æ—¶éªŒè¯

---

### âš ï¸ é”™è¯¯å¤„ç†æ”¹è¿› (2024å¹´8æœˆ)

#### **ä¸»è¦æ”¹è¿›**
1. **deploy.shè„šæœ¬æ”¹è¿›**: å¢å¼ºçš„åŒ…å®‰è£…é€»è¾‘ã€ç”¨æˆ·äº¤äº’å¼å¤„ç†ã€å®Œæ•´çš„é”™è¯¯å¤„ç†
2. **nftables_generator.pyæ”¹è¿›**: è¿æ¥ç®¡ç†å®¹é”™ã€è¿æ¥æŸ¥è¯¢å®¹é”™

#### **å¤šåŒ…åå°è¯•æœºåˆ¶**
```bash
# å°è¯•ä¸åŒçš„åŒ…å
if apt-get install -y conntrack-tools 2>/dev/null; then
    echo "âœ… conntrack-toolså®‰è£…æˆåŠŸ"
elif apt-get install -y conntrack 2>/dev/null; then
    echo "âœ… conntrackå®‰è£…æˆåŠŸ"
elif apt-get install -y conntrackd 2>/dev/null; then
    echo "âœ… conntrackdå®‰è£…æˆåŠŸ"
fi
```

#### **ç”¨æˆ·äº¤äº’å¤„ç†**
```bash
if [ "$CONNTRACK_INSTALLED" = false ]; then
    echo "âš ï¸ æ³¨æ„: è¿æ¥çŠ¶æ€ç®¡ç†åŠŸèƒ½å°†ä¸å¯ç”¨ï¼Œä½†å…¶ä»–åŠŸèƒ½æ­£å¸¸"
    echo "æ˜¯å¦ç»§ç»­éƒ¨ç½²? (y/N)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo "éƒ¨ç½²å·²å–æ¶ˆ"
        exit 1
    fi
    echo "ç»§ç»­éƒ¨ç½²ï¼Œè·³è¿‡conntrackå®‰è£…..."
fi
```

#### **ä¼˜é›…é™çº§å¤„ç†**
```python
def _terminate_active_connections(self, ip_address: str) -> bool:
    try:
        subprocess.run(['conntrack', '-h'], capture_output=True, check=True)
    except (FileNotFoundError, subprocess.CalledProcessError):
        logger.warning("`conntrack` å‘½ä»¤æœªæ‰¾åˆ°æˆ–æ— æ³•æ‰§è¡Œã€‚è¿æ¥çŠ¶æ€ç®¡ç†åŠŸèƒ½ä¸å¯ç”¨ã€‚")
        logger.info("IPå·²è¢«æ·»åŠ åˆ°é»‘åå•ï¼Œæ–°è¿æ¥å°†è¢«æ‹¦æˆªï¼Œä½†ç°æœ‰è¿æ¥å¯èƒ½ç»§ç»­å­˜åœ¨ã€‚")
        return False
```

---

### ğŸ”§ å‰ç«¯æ„å»ºä¿®å¤ (2024å¹´8æœˆ)

#### **é—®é¢˜æè¿°**
å‰ç«¯æ„å»ºå¤±è´¥ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
Module not found: Error: Can't resolve 'react-copy-to-clipboard' in '/opt/yk-safe/frontend/src/pages'
```

#### **é—®é¢˜åŸå› **
1. **ç¼ºå¤±ä¾èµ–**: `TokenManagement.jsx` æ–‡ä»¶ä¸­ä½¿ç”¨äº† `react-copy-to-clipboard` åŒ…ï¼Œä½†åœ¨ `package.json` ä¸­æ²¡æœ‰å£°æ˜
2. **è¯­æ³•é”™è¯¯**: `Dashboard.jsx` æ–‡ä»¶ä¸­å­˜åœ¨æ³¨é‡Šè¯­æ³•é”™è¯¯

#### **è§£å†³æ–¹æ¡ˆ**
1. **æ·»åŠ ç¼ºå¤±çš„ä¾èµ–**: åœ¨ `frontend/package.json` ä¸­æ·»åŠ  `react-copy-to-clipboard` ä¾èµ–
2. **ä¿®å¤è¯­æ³•é”™è¯¯**: ä¿®å¤ `Dashboard.jsx` ä¸­çš„æ³¨é‡Šè¯­æ³•é”™è¯¯

#### **ä¿®å¤ç»“æœ**
- âœ… ä¾èµ–å®‰è£…æˆåŠŸ
- âœ… æ„å»ºæˆåŠŸ
- âœ… TokenManagementé¡µé¢å¤åˆ¶åŠŸèƒ½æ­£å¸¸
- âœ… Dashboardé¡µé¢æ­£å¸¸æ˜¾ç¤º

---

### ğŸš€ éƒ¨ç½²è„šæœ¬ä¼˜åŒ– (2024å¹´8æœˆ)

#### **deploy.shä¼˜åŒ–**
- æ·»åŠ Dockerå®¹å™¨çŠ¶æ€æ£€æŸ¥ï¼Œåœ¨åº”ç”¨nftablesé…ç½®å‰æç¤ºç”¨æˆ·ç¡®è®¤
- æä¾›ç½‘ç»œæ¢å¤å»ºè®®
- åŒ…å«äº¤äº’å¼ç«¯å£é…ç½®ï¼ˆFRONTEND_PORT, BACKEND_PORTï¼‰
- ä¿®æ”¹æ–‡ä»¶å¤åˆ¶é€»è¾‘ï¼Œç¡®ä¿ä¸åˆ é™¤æºç›®å½•æ–‡ä»¶

#### **deploy-safe.shåˆ›å»º**
- ä¸“ä¸ºæœ‰ç°æœ‰Dockerå®¹å™¨çš„ç¯å¢ƒè®¾è®¡çš„å®‰å…¨éƒ¨ç½²è„šæœ¬
- åº”ç”¨nftablesè§„åˆ™æ—¶ä¸ä½¿ç”¨ `flush ruleset`
- äº¤äº’å¼ç«¯å£é…ç½®å’Œéƒ¨ç½²è·¯å¾„é€‰æ‹©
- å®Œæ•´çš„ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥å’Œè‡ªåŠ¨å®‰è£…

#### **å…³é”®ç‰¹æ€§**
- **å®‰å…¨æ¨¡å¼**: ä¸å¹²æ‰°ç°æœ‰Dockerç½‘ç»œé…ç½®
- **è·¯å¾„é€‰æ‹©**: ç”¨æˆ·å¯é€‰æ‹©éƒ¨ç½²è·¯å¾„ï¼Œé»˜è®¤ `/opt/$APP_NAME`
- **ç«¯å£é…ç½®**: äº¤äº’å¼é…ç½®å‰ç«¯ç«¯å£ï¼ˆé»˜è®¤5023ï¼‰å’Œåç«¯ç«¯å£ï¼ˆé»˜è®¤8000ï¼‰
- **ç¯å¢ƒæ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±çš„ç³»ç»Ÿç»„ä»¶
- **æ–‡ä»¶ç®¡ç†**: æ™ºèƒ½çš„æ–‡ä»¶å¤åˆ¶å’Œæ¸…ç†é€»è¾‘

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### **ç³»ç»Ÿè¦æ±‚**
- **æ“ä½œç³»ç»Ÿ**: Debian 11+ æˆ– Ubuntu 20.04+
- **æƒé™**: root æƒé™
- **ç½‘ç»œ**: äº’è”ç½‘è¿æ¥

### **è‡ªåŠ¨å®‰è£…çš„ä¾èµ–**
- Python3 + pip + venv
- nginx
- nftables
- conntrack-tools
- systemd

### **éƒ¨ç½²æµç¨‹**
```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd yk-safe

# è¿è¡Œéƒ¨ç½²è„šæœ¬
sudo ./deploy.sh

# æˆ–è€…ä½¿ç”¨å®‰å…¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èæœ‰Dockerå®¹å™¨çš„ç¯å¢ƒï¼‰
sudo ./deploy-safe.sh
```

### **éƒ¨ç½²åè®¿é—®**
- **ä¸»ç³»ç»Ÿ**: http://your-server:5023/
- **ç™½åå•ç”³è¯·**: http://your-server:5023/whitelist.html
- **APIæ–‡æ¡£**: http://your-server:5023/docs

### **é»˜è®¤è´¦æˆ·**
- **ç”¨æˆ·å**: admin
- **å¯†ç **: admin123

### **æœåŠ¡ç®¡ç†**
```bash
# æŸ¥çœ‹çŠ¶æ€
systemctl status yk-safe-backend

# é‡å¯æœåŠ¡
systemctl restart yk-safe-backend

# æŸ¥çœ‹æ—¥å¿—
journalctl -u yk-safe-backend -f

# åœæ­¢æœåŠ¡
systemctl stop yk-safe-backend
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²æˆ–ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—å’Œé˜²ç«å¢™çŠ¶æ€
3. éªŒè¯ç½‘ç»œè¿æ¥å’ŒAPIçŠ¶æ€
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**é¡¹ç›®çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯  
**æ”¯æŒç³»ç»Ÿ**: Debian/Ubuntu  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
