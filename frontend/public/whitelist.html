<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½åå•IPç”³è¯· - å°ç¥äº‘é˜²æŠ¤ç³»ç»Ÿ</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #1890ff;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .form-item {
            margin-bottom: 24px;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d9d9d9;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
        }
        
        .form-input:read-only {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .ip-input-hint {
            margin-top: 6px;
            margin-bottom: 8px;
        }
        
        .ip-input-hint small {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .ip-validation-hint {
            margin-top: 6px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
            display: none;
        }
        
        .ip-validation-hint.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .ip-validation-hint.warning {
            background: #fff7e6;
            border: 1px solid #ffd591;
            color: #fa8c16;
        }
        
        .ip-validation-hint.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .btn {
            width: 100%;
            padding: 12px 24px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-warning {
            background: #fff7e6;
            border: 1px solid #ffd591;
            color: #fa8c16;
        }
        .alert-success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .alert-error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        
        /* IPä½ç½®ä¿¡æ¯æ ·å¼ */
        .ip-location-info {
            margin-top: 8px;
            padding: 12px;
            border-radius: 6px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            display: none;
        }
        
        .ip-location-info.show {
            display: block;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .ip-location-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
            color: #0369a1;
        }
        
        .ip-location-header .icon {
            margin-right: 6px;
            font-size: 14px;
        }
        
        .ip-location-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
        }
        
        .location-item {
            display: flex;
            align-items: center;
            color: #0c4a6e;
        }
        
        .location-item .label {
            font-weight: 500;
            margin-right: 4px;
        }
        
        .location-item .value {
            color: #0369a1;
        }
        
        .location-item .flag {
            margin-right: 4px;
            font-size: 12px;
        }
        
        .location-loading {
            display: flex;
            align-items: center;
            color: #0369a1;
            font-size: 13px;
        }
        
        .location-loading .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #bae6fd;
            border-top: 2px solid #0369a1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 6px;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .ip-location-details {
                flex-direction: column;
                gap: 8px;
            }
            
            .location-item {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <div>
                    <h1>ğŸ”’ ç™½åå•IPç”³è¯·</h1>
                    <p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯ç”³è¯·å°†æ‚¨çš„IPåœ°å€æ·»åŠ åˆ°ç™½åå•</p>
                </div>
            </div>

            <div id="proxy-warning" class="alert alert-warning" style="display: none;">
                <!-- ä»£ç†è­¦å‘Šå†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            


            <form id="whitelist-form">
                <div class="form-item">
                    <label class="form-label">ğŸ¢ å…¬å¸åç§° *</label>
                    <input type="text" id="company-name" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å…¬å¸åç§°" required>
                </div>

                <div class="form-item">
                    <label class="form-label">ğŸ”‘ ç”³è¯·Token *</label>
                    <input type="text" id="token" class="form-input" placeholder="è¯·è¾“å…¥ç”³è¯·Token" required>
                </div>

                <div class="form-item">
                    <label class="form-label">ğŸ“ IPåœ°å€ *</label>
                    <input type="text" id="ip-address" class="form-input" placeholder="è‡ªåŠ¨è·å–ä¸­..." readonly>
                    <div class="ip-input-hint">
                        <small class="text-muted">ğŸ’¡ ç³»ç»Ÿä¼šè‡ªåŠ¨è·å–æ‚¨çš„IPåœ°å€ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥æˆ–ä¿®æ”¹</small>
                    </div>
                    <div id="ip-location-info" class="ip-location-info">
                        <div class="ip-location-header">
                            <span class="icon">ğŸŒ</span>
                            <span>IPåœ°å€ä½ç½®ä¿¡æ¯</span>
                        </div>
                        <div id="ip-location-content">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...</span>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="btn" disabled>
                    æäº¤ç”³è¯·
                </button>
            </form>

            <div id="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/whitelist';

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹ç½‘ç»œç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', async function() {
            await detectNetworkEnvironment();
            
            // ä¸ºIPåœ°å€è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const ipInput = document.getElementById('ip-address');
            ipInput.addEventListener('input', async function() {
                // å®æ—¶éªŒè¯IPåœ°å€æ ¼å¼
                const isValid = validateIPInput(this);
                
                if (isValid) {
                    const ip = this.value.trim();
                    // è·å–IPä½ç½®ä¿¡æ¯
                    const locationData = await getIpLocationInfo(ip);
                    if (locationData && locationData.success) {
                        showIpLocationInfo(ip, locationData);
                    }
                } else {
                    hideIpLocationInfo();
                }
            });
            
            // æ·»åŠ å¤±ç„¦éªŒè¯
            ipInput.addEventListener('blur', function() {
                const ip = this.value.trim();
                if (ip) {
                    validateIPInput(this);
                }
            });
            
            // æ·»åŠ ç„¦ç‚¹äº‹ä»¶ï¼Œå½“ç”¨æˆ·ç‚¹å‡»è¾“å…¥æ¡†æ—¶æ˜¾ç¤ºæç¤º
            ipInput.addEventListener('focus', function() {
                if (this.readOnly) {
                    this.placeholder = 'æ­£åœ¨è‡ªåŠ¨è·å–IPåœ°å€...';
                } else {
                    this.placeholder = 'è¯·è¾“å…¥æ‚¨çš„å…¬ç½‘IPåœ°å€';
                }
            });
            
            // æ·»åŠ å¤±ç„¦äº‹ä»¶ï¼Œå½“ç”¨æˆ·å®Œæˆè¾“å…¥åæ¢å¤æç¤º
            ipInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                    this.placeholder = 'IPåœ°å€å·²è¾“å…¥ï¼Œæ‚¨å¯ä»¥ç»§ç»­ä¿®æ”¹';
                } else {
                    this.placeholder = 'è¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„å…¬ç½‘IPåœ°å€';
                }
            });
        });

        // IPåœ°å€éªŒè¯å‡½æ•°
        function isValidIP(ip) {
            if (!ip || typeof ip !== 'string') {
                return false;
            }
            
            const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipPattern.test(ip.trim());
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰IPåœ°å€
        function isPrivateIP(ip) {
            if (!isValidIP(ip)) {
                return false;
            }
            
            const parts = ip.split('.').map(Number);
            const first = parts[0];
            const second = parts[1];
            
            // ç§æœ‰IPåœ°å€èŒƒå›´
            return (
                // 10.0.0.0 - 10.255.255.255
                (first === 10) ||
                // 172.16.0.0 - 172.31.255.255
                (first === 172 && second >= 16 && second <= 31) ||
                // 192.168.0.0 - 192.168.255.255
                (first === 192 && second === 168) ||
                // 127.0.0.0 - 127.255.255.255 (æœ¬åœ°å›ç¯)
                (first === 127) ||
                // 169.254.0.0 - 169.254.255.255 (é“¾è·¯æœ¬åœ°)
                (first === 169 && second === 254) ||
                // 0.0.0.0 - 0.255.255.255
                (first === 0)
            );
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå…¬ç½‘IPåœ°å€
        function isPublicIP(ip) {
            return isValidIP(ip) && !isPrivateIP(ip);
        }
        
        // å®æ—¶IPåœ°å€éªŒè¯å’Œæç¤º
        function validateIPInput(input) {
            const ip = input.value.trim();
            const hintElement = input.parentNode.querySelector('.ip-validation-hint');
            
            if (!ip) {
                if (hintElement) {
                    hintElement.style.display = 'none';
                }
                return false;
            }
            
            if (!isValidIP(ip)) {
                showIPValidationHint(input, 'âŒ IPåœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPv4åœ°å€', 'error');
                return false;
            }
            
            if (isPrivateIP(ip)) {
                showIPValidationHint(input, 'âš ï¸ æ£€æµ‹åˆ°ç§æœ‰IPåœ°å€ï¼Œè¯·ç¡®ä¿è¾“å…¥çš„æ˜¯æ‚¨çš„å…¬ç½‘IPåœ°å€', 'warning');
                return false;
            }
            
            if (isPublicIP(ip)) {
                showIPValidationHint(input, 'âœ… IPåœ°å€æ ¼å¼æ­£ç¡®', 'success');
                return true;
            }
            
            return false;
        }
        
        // æ˜¾ç¤ºIPéªŒè¯æç¤º
        function showIPValidationHint(input, message, type) {
            let hintElement = input.parentNode.querySelector('.ip-validation-hint');
            
            if (!hintElement) {
                hintElement = document.createElement('div');
                hintElement.className = 'ip-validation-hint';
                input.parentNode.appendChild(hintElement);
            }
            
            hintElement.textContent = message;
            hintElement.className = `ip-validation-hint ${type}`;
            hintElement.style.display = 'block';
        }

        // æ£€æµ‹ç½‘ç»œç¯å¢ƒ
        // åœ¨detectNetworkEnvironmentå‡½æ•°ä¸­æ·»åŠ IPéªŒè¯
        async function detectNetworkEnvironment() {
            try {
                console.log('å¼€å§‹æ£€æµ‹ç½‘ç»œç¯å¢ƒ...');
                console.log('APIåŸºç¡€URL:', API_BASE);
                
                // å°è¯•å¤šç§æ–¹å¼è·å–ç”¨æˆ·IPåœ°å€
                let publicIp = null;
                let ipSource = '';
                
                // æ–¹æ³•1: å°è¯•ä½¿ç”¨ç¬¬ä¸‰æ–¹IPæ£€æµ‹æœåŠ¡
                try {
                    console.log('æ­£åœ¨é€šè¿‡ç¬¬ä¸‰æ–¹æœåŠ¡è·å–å…¬ç½‘IP...');
                    const thirdPartyResponse = await fetch('https://api.ipify.org?format=json', {
                        method: 'GET',
                        signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
                    });
                    
                    if (thirdPartyResponse.ok) {
                        const thirdPartyData = await thirdPartyResponse.json();
                        publicIp = thirdPartyData.ip;
                        ipSource = 'ç¬¬ä¸‰æ–¹æœåŠ¡';
                        console.log('ç¬¬ä¸‰æ–¹æœåŠ¡è·å–IPæˆåŠŸ:', publicIp);
                    }
                } catch (thirdPartyError) {
                    console.log('ç¬¬ä¸‰æ–¹æœåŠ¡è·å–IPå¤±è´¥:', thirdPartyError.message);
                }
                
                // æ–¹æ³•2: å¦‚æœç¬¬ä¸‰æ–¹æœåŠ¡å¤±è´¥ï¼Œå°è¯•åç«¯API
                if (!publicIp) {
                    try {
                        console.log('æ­£åœ¨é€šè¿‡åç«¯APIè·å–å…¬ç½‘IP...');
                        const ipResponse = await fetch(`${API_BASE}/public/ip`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            signal: AbortSignal.timeout(8000) // 8ç§’è¶…æ—¶
                        });
                        
                        if (ipResponse.ok) {
                            const ipData = await ipResponse.json();
                            console.log('åç«¯API IPæ•°æ®:', ipData);
                            publicIp = ipData.ip;
                            ipSource = 'åç«¯API';
                        }
                    } catch (backendError) {
                        console.log('åç«¯APIè·å–IPå¤±è´¥:', backendError.message);
                    }
                }
                
                // éªŒè¯è·å–åˆ°çš„IPåœ°å€
                if (!publicIp || !isValidIP(publicIp) || isPrivateIP(publicIp)) {
                    console.log('è·å–åˆ°çš„IPåœ°å€æ— æ•ˆæˆ–ä¸ºç§æœ‰IP:', publicIp);
                    // å…è®¸ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                    document.getElementById('ip-address').readOnly = false;
                    document.getElementById('ip-address').placeholder = 'è¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„å…¬ç½‘IPåœ°å€';
                    showAlert('æ— æ³•è‡ªåŠ¨è·å–æ‚¨çš„å…¬ç½‘IPï¼Œè¯·æ‰‹åŠ¨è¾“å…¥', 'warning');
                    document.getElementById('submit-btn').disabled = false;
                    return;
                }
                
                console.log(`é€šè¿‡${ipSource}æˆåŠŸè·å–IPåœ°å€:`, publicIp);
                
                // æ£€æµ‹ä»£ç†çŠ¶æ€
                console.log('æ­£åœ¨æ£€æµ‹ä»£ç†çŠ¶æ€...');
                const proxyResponse = await fetch(`${API_BASE}/public/proxy-check`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
                });
                console.log('ä»£ç†å“åº”çŠ¶æ€:', proxyResponse.status);
                
                if (!proxyResponse.ok) {
                    const errorText = await proxyResponse.text();
                    console.error('ä»£ç†æ£€æµ‹å“åº”å†…å®¹:', errorText);
                    throw new Error(`ä»£ç†æ£€æµ‹å¤±è´¥: ${proxyResponse.status} ${proxyResponse.statusText}`);
                }
                
                const proxyData = await proxyResponse.json();
                console.log('ä»£ç†æ•°æ®:', proxyData);
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤ºå¹¶å…è®¸ç”¨æˆ·ç¼–è¾‘
                document.getElementById('ip-address').value = publicIp;
                document.getElementById('ip-address').readOnly = false;
                document.getElementById('ip-address').placeholder = 'IPåœ°å€å·²è‡ªåŠ¨è·å–ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹';
                
                // è°ƒè¯•ä¿¡æ¯ï¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºä»£ç†æ£€æµ‹ç»“æœ
                console.log('ä»£ç†æ£€æµ‹ç»“æœ:', {
                    is_proxy: proxyData.is_proxy,
                    confidence: proxyData.confidence,
                    proxy_type: proxyData.proxy_type,
                    country: proxyData.country,
                    city: proxyData.city,
                    isp: proxyData.isp
                });

                // æ›´æ–°è°ƒè¯•ä¿¡æ¯åŒºåŸŸ
                updateDebugInfo(proxyData);

                // æ”¹è¿›çš„ä»£ç†æ£€æµ‹é€»è¾‘ï¼šåªæœ‰åœ¨æ˜ç¡®æ£€æµ‹åˆ°ä»£ç†æ—¶æ‰æ˜¾ç¤ºè­¦å‘Š
                if (proxyData.is_proxy && proxyData.confidence && proxyData.confidence > 0.8) {
                    // é«˜ç½®ä¿¡åº¦çš„ä»£ç†æ£€æµ‹ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„è­¦å‘Š
                    const proxyWarning = document.getElementById('proxy-warning');
                    proxyWarning.style.display = 'block';
                    proxyWarning.className = 'alert alert-warning';
                    
                    // å¦‚æœæœ‰ä»£ç†è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ›´å…·ä½“çš„è­¦å‘Š
                    if (proxyData.proxy_type) {
                        proxyWarning.innerHTML = `
                            <strong>âš ï¸ ä»£ç†æ£€æµ‹è­¦å‘Šï¼š</strong>
                            æ£€æµ‹åˆ°æ‚¨å¯èƒ½æ­£åœ¨ä½¿ç”¨${proxyData.proxy_type}ï¼Œè¿™å¯èƒ½ä¼šå½±å“IPåœ°å€çš„å‡†ç¡®æ€§ã€‚
                            <br><small>æ£€æµ‹ç½®ä¿¡åº¦: ${Math.round(proxyData.confidence * 100)}%</small>
                        `;
                    } else {
                        proxyWarning.innerHTML = `
                            <strong>âš ï¸ ä»£ç†æ£€æµ‹è­¦å‘Šï¼š</strong>
                            æ£€æµ‹åˆ°æ‚¨å¯èƒ½æ­£åœ¨ä½¿ç”¨ä»£ç†æˆ–VPNï¼Œè¿™å¯èƒ½ä¼šå½±å“IPåœ°å€çš„å‡†ç¡®æ€§ã€‚
                            <br><small>æ£€æµ‹ç½®ä¿¡åº¦: ${Math.round(proxyData.confidence * 100)}%</small>
                        `;
                    }
                } else if (proxyData.is_proxy && proxyData.confidence && proxyData.confidence > 0.6) {
                    // ä¸­ç­‰ç½®ä¿¡åº¦çš„ä»£ç†æ£€æµ‹ï¼Œæ˜¾ç¤ºæ¸©å’Œçš„æç¤º
                    const proxyWarning = document.getElementById('proxy-warning');
                    proxyWarning.style.display = 'block';
                    proxyWarning.className = 'alert alert-warning';
                    proxyWarning.innerHTML = `
                        <strong>â„¹ï¸ ç½‘ç»œç¯å¢ƒæç¤ºï¼š</strong>
                        ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨çš„ç½‘ç»œç¯å¢ƒå¯èƒ½æœ‰äº›ç‰¹æ®Šï¼Œä½†ä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚
                        <br><small>æ£€æµ‹ç½®ä¿¡åº¦: ${Math.round(proxyData.confidence * 100)}% | å¦‚æœIPåœ°å€æ˜¾ç¤ºä¸æ­£ç¡®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„çœŸå®å…¬ç½‘IPåœ°å€</small>
                    `;
                } else if (proxyData.is_proxy && (!proxyData.confidence || proxyData.confidence <= 0.6)) {
                    // ä½ç½®ä¿¡åº¦çš„ä»£ç†æ£€æµ‹ï¼Œå¯èƒ½æ˜¯è¯¯åˆ¤ï¼Œä¸æ˜¾ç¤ºè­¦å‘Š
                    console.log('ä»£ç†æ£€æµ‹ç½®ä¿¡åº¦è¿‡ä½ï¼Œå¯èƒ½æ˜¯è¯¯åˆ¤ï¼Œä¸æ˜¾ç¤ºè­¦å‘Š');
                } else {
                    // æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç†ï¼Œç¡®ä¿è­¦å‘Šä¸æ˜¾ç¤º
                    document.getElementById('proxy-warning').style.display = 'none';
                }
                
                // è·å–IPä½ç½®ä¿¡æ¯
                console.log('æ­£åœ¨è·å–IPä½ç½®ä¿¡æ¯...');
                const locationData = await getIpLocationInfo(publicIp);
                if (locationData && locationData.success) {
                    showIpLocationInfo(publicIp, locationData);
                }
                
                document.getElementById('submit-btn').disabled = false;
                console.log('ç½‘ç»œç¯å¢ƒæ£€æµ‹å®Œæˆ');
                
            } catch (error) {
                console.error('ç½‘ç»œç¯å¢ƒæ£€æµ‹å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                
                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = `ç½‘ç»œç¯å¢ƒæ£€æµ‹å¤±è´¥: ${error.message}`;
                if (error.message.includes('502')) {
                    errorMessage = 'ç½‘ç»œç¯å¢ƒæ£€æµ‹å¤±è´¥: åç«¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œç¯å¢ƒæ£€æµ‹å¤±è´¥: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.name === 'TimeoutError') {
                    errorMessage = 'ç½‘ç»œç¯å¢ƒæ£€æµ‹è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                } else if (error.message.includes('AbortError')) {
                    errorMessage = 'ç½‘ç»œè¯·æ±‚è¢«ä¸­æ–­ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                showAlert(errorMessage, 'error');
                
                // é‡è¦ï¼šæ— è®ºä»€ä¹ˆé”™è¯¯ï¼Œéƒ½è¦ç¡®ä¿ç”¨æˆ·èƒ½æ‰‹åŠ¨è¾“å…¥IPåœ°å€
                document.getElementById('ip-address').readOnly = false;
                document.getElementById('ip-address').placeholder = 'è¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„å…¬ç½‘IPåœ°å€';
                document.getElementById('submit-btn').disabled = false;
                
                // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤º
                showAlert('ç”±äºè‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æ‚¨çš„å…¬ç½‘IPåœ°å€', 'warning');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const form = document.getElementById('whitelist-form');
            form.parentNode.insertBefore(alertDiv, form);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // è·å–IPä½ç½®ä¿¡æ¯
        async function getIpLocationInfo(ipAddress) {
            try {
                const response = await fetch(`${API_BASE}/public/ip-location`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ ip: ipAddress }),
                    signal: AbortSignal.timeout(8000) // 8ç§’è¶…æ—¶
                });
                
                if (!response.ok) {
                    throw new Error(`ä½ç½®ä¿¡æ¯è·å–å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('è·å–IPä½ç½®ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }



        // æ˜¾ç¤ºIPä½ç½®ä¿¡æ¯
        function showIpLocationInfo(ipAddress, locationData) {
            const locationInfo = document.getElementById('ip-location-info');
            const locationContent = document.getElementById('ip-location-content');
            
            if (!locationData || !locationData.location) {
                locationContent.innerHTML = `
                    <div class="location-item">
                        <span class="label">IPåœ°å€:</span>
                        <span class="value">${ipAddress}</span>
                    </div>
                    <div class="location-item">
                        <span class="label">ä½ç½®:</span>
                        <span class="value">ä½ç½®ä¿¡æ¯ä¸å¯ç”¨</span>
                    </div>
                `;
            } else {
                const location = locationData.location;
                const flag = getCountryFlag(location.country);
                
                locationContent.innerHTML = `
                    <div class="ip-location-details">
                        <div class="location-item">
                            <span class="flag">${flag}</span>
                            <span class="label">å›½å®¶/åœ°åŒº:</span>
                            <span class="value">${location.country || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="location-item">
                            <span class="label">åŸå¸‚:</span>
                            <span class="value">${location.city || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="location-item">
                            <span class="label">åœ°åŒº:</span>
                            <span class="value">${location.region || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="location-item">
                            <span class="label">æ—¶åŒº:</span>
                            <span class="value">${location.timezone || 'æœªçŸ¥'}</span>
                        </div>
                    </div>
                `;
            }
            
            locationInfo.classList.add('show');
        }

        // éšè—IPä½ç½®ä¿¡æ¯
        function hideIpLocationInfo() {
            const locationInfo = document.getElementById('ip-location-info');
            locationInfo.classList.remove('show');
            locationInfo.style.display = 'none';
        }

        // è·å–å›½å®¶å›½æ——emoji
        function getCountryFlag(countryName) {
            const flagMap = {
                'China': 'ğŸ‡¨ğŸ‡³',
                'United States': 'ğŸ‡ºğŸ‡¸',
                'Japan': 'ğŸ‡¯ğŸ‡µ',
                'South Korea': 'ğŸ‡°ğŸ‡·',
                'Singapore': 'ğŸ‡¸ğŸ‡¬',
                'Hong Kong': 'ğŸ‡­ğŸ‡°',
                'Taiwan': 'ğŸ‡¹ğŸ‡¼',
                'United Kingdom': 'ğŸ‡¬ğŸ‡§',
                'Germany': 'ğŸ‡©ğŸ‡ª',
                'France': 'ğŸ‡«ğŸ‡·',
                'Canada': 'ğŸ‡¨ğŸ‡¦',
                'Australia': 'ğŸ‡¦ğŸ‡º',
                'Russia': 'ğŸ‡·ğŸ‡º',
                'India': 'ğŸ‡®ğŸ‡³',
                'Brazil': 'ğŸ‡§ğŸ‡·',
                'Mexico': 'ğŸ‡²ğŸ‡½',
                'Italy': 'ğŸ‡®ğŸ‡¹',
                'Spain': 'ğŸ‡ªğŸ‡¸',
                'Netherlands': 'ğŸ‡³ğŸ‡±',
                'Sweden': 'ğŸ‡¸ğŸ‡ª',
                'Switzerland': 'ğŸ‡¨ğŸ‡­',
                'Norway': 'ğŸ‡³ğŸ‡´',
                'Denmark': 'ğŸ‡©ğŸ‡°',
                'Finland': 'ğŸ‡«ğŸ‡®',
                'Poland': 'ğŸ‡µğŸ‡±',
                'Austria': 'ğŸ‡¦ğŸ‡¹',
                'Belgium': 'ğŸ‡§ğŸ‡ª',
                'Ireland': 'ğŸ‡®ğŸ‡ª',
                'Portugal': 'ğŸ‡µğŸ‡¹',
                'Greece': 'ğŸ‡¬ğŸ‡·',
                'Czech Republic': 'ğŸ‡¨ğŸ‡¿',
                'Hungary': 'ğŸ‡­ğŸ‡º',
                'Romania': 'ğŸ‡·ğŸ‡´',
                'Bulgaria': 'ğŸ‡§ğŸ‡¬',
                'Croatia': 'ğŸ‡­ğŸ‡·',
                'Slovakia': 'ğŸ‡¸ğŸ‡°',
                'Slovenia': 'ğŸ‡¸ğŸ‡®',
                'Estonia': 'ğŸ‡ªğŸ‡ª',
                'Latvia': 'ğŸ‡±ğŸ‡»',
                'Lithuania': 'ğŸ‡±ğŸ‡¹',
                'Luxembourg': 'ğŸ‡±ğŸ‡º',
                'Malta': 'ğŸ‡²ğŸ‡¹',
                'Cyprus': 'ğŸ‡¨ğŸ‡¾',
                'Iceland': 'ğŸ‡®ğŸ‡¸',
                'Liechtenstein': 'ğŸ‡±ğŸ‡®',
                'Monaco': 'ğŸ‡²ğŸ‡¨',
                'San Marino': 'ğŸ‡¸ğŸ‡²',
                'Vatican City': 'ğŸ‡»ğŸ‡¦',
                'Andorra': 'ğŸ‡¦ğŸ‡©',
                'Albania': 'ğŸ‡¦ğŸ‡±',
                'Bosnia and Herzegovina': 'ğŸ‡§ğŸ‡¦',
                'Montenegro': 'ğŸ‡²ğŸ‡ª',
                'North Macedonia': 'ğŸ‡²ğŸ‡°',
                'Serbia': 'ğŸ‡·ğŸ‡¸',
                'Kosovo': 'ğŸ‡½ğŸ‡°',
                'Moldova': 'ğŸ‡²ğŸ‡©',
                'Ukraine': 'ğŸ‡ºğŸ‡¦',
                'Belarus': 'ğŸ‡§ğŸ‡¾',
                'Georgia': 'ğŸ‡¬ğŸ‡ª',
                'Armenia': 'ğŸ‡¦ğŸ‡²',
                'Azerbaijan': 'ğŸ‡¦ğŸ‡¿',
                'Kazakhstan': 'ğŸ‡°ğŸ‡¿',
                'Uzbekistan': 'ğŸ‡ºğŸ‡¿',
                'Kyrgyzstan': 'ğŸ‡°ğŸ‡¬',
                'Tajikistan': 'ğŸ‡¹ğŸ‡¯',
                'Turkmenistan': 'ğŸ‡¹ğŸ‡²',
                'Mongolia': 'ğŸ‡²ğŸ‡³',
                'Vietnam': 'ğŸ‡»ğŸ‡³',
                'Thailand': 'ğŸ‡¹ğŸ‡­',
                'Malaysia': 'ğŸ‡²ğŸ‡¾',
                'Indonesia': 'ğŸ‡®ğŸ‡©',
                'Philippines': 'ğŸ‡µğŸ‡­',
                'Myanmar': 'ğŸ‡²ğŸ‡²',
                'Cambodia': 'ğŸ‡°ğŸ‡­',
                'Laos': 'ğŸ‡±ğŸ‡¦',
                'Brunei': 'ğŸ‡§ğŸ‡³',
                'East Timor': 'ğŸ‡¹ğŸ‡±',
                'Papua New Guinea': 'ğŸ‡µğŸ‡¬',
                'Fiji': 'ğŸ‡«ğŸ‡¯',
                'New Zealand': 'ğŸ‡³ğŸ‡¿',
                'Pakistan': 'ğŸ‡µğŸ‡°',
                'Bangladesh': 'ğŸ‡§ğŸ‡©',
                'Sri Lanka': 'ğŸ‡±ğŸ‡°',
                'Nepal': 'ğŸ‡³ğŸ‡µ',
                'Bhutan': 'ğŸ‡§ğŸ‡¹',
                'Maldives': 'ğŸ‡²ğŸ‡»',
                'Afghanistan': 'ğŸ‡¦ğŸ‡«',
                'Iran': 'ğŸ‡®ğŸ‡·',
                'Iraq': 'ğŸ‡®ğŸ‡¶',
                'Syria': 'ğŸ‡¸ğŸ‡¾',
                'Lebanon': 'ğŸ‡±ğŸ‡§',
                'Jordan': 'ğŸ‡¯ğŸ‡´',
                'Israel': 'ğŸ‡®ğŸ‡±',
                'Palestine': 'ğŸ‡µğŸ‡¸',
                'Saudi Arabia': 'ğŸ‡¸ğŸ‡¦',
                'Yemen': 'ğŸ‡¾ğŸ‡ª',
                'Oman': 'ğŸ‡´ğŸ‡²',
                'United Arab Emirates': 'ğŸ‡¦ğŸ‡ª',
                'Qatar': 'ğŸ‡¶ğŸ‡¦',
                'Bahrain': 'ğŸ‡§ğŸ‡­',
                'Kuwait': 'ğŸ‡°ğŸ‡¼',
                'Egypt': 'ğŸ‡ªğŸ‡¬',
                'Libya': 'ğŸ‡±ğŸ‡¾',
                'Tunisia': 'ğŸ‡¹ğŸ‡³',
                'Algeria': 'ğŸ‡©ğŸ‡¿',
                'Morocco': 'ğŸ‡²ğŸ‡¦',
                'Sudan': 'ğŸ‡¸ğŸ‡©',
                'South Sudan': 'ğŸ‡¸ğŸ‡¸',
                'Ethiopia': 'ğŸ‡ªğŸ‡¹',
                'Eritrea': 'ğŸ‡ªğŸ‡·',
                'Djibouti': 'ğŸ‡©ğŸ‡¯',
                'Somalia': 'ğŸ‡¸ğŸ‡´',
                'Kenya': 'ğŸ‡°ğŸ‡ª',
                'Uganda': 'ğŸ‡ºğŸ‡¬',
                'Tanzania': 'ğŸ‡¹ğŸ‡¿',
                'Rwanda': 'ğŸ‡·ğŸ‡¼',
                'Burundi': 'ğŸ‡§ğŸ‡®',
                'Democratic Republic of the Congo': 'ğŸ‡¨ğŸ‡©',
                'Republic of the Congo': 'ğŸ‡¨ğŸ‡¬',
                'Central African Republic': 'ğŸ‡¨ğŸ‡«',
                'Chad': 'ğŸ‡¹ğŸ‡©',
                'Cameroon': 'ğŸ‡¨ğŸ‡²',
                'Nigeria': 'ğŸ‡³ğŸ‡¬',
                'Niger': 'ğŸ‡³ğŸ‡ª',
                'Mali': 'ğŸ‡²ğŸ‡±',
                'Burkina Faso': 'ğŸ‡§ğŸ‡«',
                'Senegal': 'ğŸ‡¸ğŸ‡³',
                'Gambia': 'ğŸ‡¬ğŸ‡²',
                'Guinea-Bissau': 'ğŸ‡¬ğŸ‡¼',
                'Guinea': 'ğŸ‡¬ğŸ‡³',
                'Sierra Leone': 'ğŸ‡¸ğŸ‡±',
                'Liberia': 'ğŸ‡±ğŸ‡·',
                'Ivory Coast': 'ğŸ‡¨ğŸ‡®',
                'Ghana': 'ğŸ‡¬ğŸ‡­',
                'Togo': 'ğŸ‡¹ğŸ‡¬',
                'Benin': 'ğŸ‡§ğŸ‡¯',
                'Equatorial Guinea': 'ğŸ‡¬ğŸ‡¶',
                'Gabon': 'ğŸ‡¬ğŸ‡¦',
                'SÃ£o TomÃ© and PrÃ­ncipe': 'ğŸ‡¸ğŸ‡¹',
                'Angola': 'ğŸ‡¦ğŸ‡´',
                'Zambia': 'ğŸ‡¿ğŸ‡²',
                'Zimbabwe': 'ğŸ‡¿ğŸ‡¼',
                'Botswana': 'ğŸ‡§ğŸ‡¼',
                'Namibia': 'ğŸ‡³ğŸ‡¦',
                'South Africa': 'ğŸ‡¿ğŸ‡¦',
                'Lesotho': 'ğŸ‡±ğŸ‡¸',
                'Eswatini': 'ğŸ‡¸ğŸ‡¿',
                'Madagascar': 'ğŸ‡²ğŸ‡¬',
                'Mauritius': 'ğŸ‡²ğŸ‡º',
                'Seychelles': 'ğŸ‡¸ğŸ‡¨',
                'Comoros': 'ğŸ‡°ğŸ‡²',
                'Mayotte': 'ğŸ‡¾ğŸ‡¹',
                'RÃ©union': 'ğŸ‡·ğŸ‡ª',
                'Argentina': 'ğŸ‡¦ğŸ‡·',
                'Chile': 'ğŸ‡¨ğŸ‡±',
                'Peru': 'ğŸ‡µğŸ‡ª',
                'Bolivia': 'ğŸ‡§ğŸ‡´',
                'Paraguay': 'ğŸ‡µğŸ‡¾',
                'Uruguay': 'ğŸ‡ºğŸ‡¾',
                'Colombia': 'ğŸ‡¨ğŸ‡´',
                'Venezuela': 'ğŸ‡»ğŸ‡ª',
                'Ecuador': 'ğŸ‡ªğŸ‡¨',
                'Guyana': 'ğŸ‡¬ğŸ‡¾',
                'Suriname': 'ğŸ‡¸ğŸ‡·',
                'French Guiana': 'ğŸ‡¬ğŸ‡«',
                'Falkland Islands': 'ğŸ‡«ğŸ‡°',
                'South Georgia': 'ğŸ‡¬ğŸ‡¸',
                'Antarctica': 'ğŸ‡¦ğŸ‡¶',
                'Greenland': 'ğŸ‡¬ğŸ‡±',
                'Iceland': 'ğŸ‡®ğŸ‡¸',
                'Faroe Islands': 'ğŸ‡«ğŸ‡´',
                'Svalbard': 'ğŸ‡¸ğŸ‡¯',
                'Jan Mayen': 'ğŸ‡³ğŸ‡´',
                'Bouvet Island': 'ğŸ‡§ğŸ‡»',
                'Heard Island': 'ğŸ‡­ğŸ‡²',
                'McDonald Islands': 'ğŸ‡¦ğŸ‡º',
                'French Southern Territories': 'ğŸ‡¹ğŸ‡«',
                'South Sandwich Islands': 'ğŸ‡¬ğŸ‡¸',
                'British Indian Ocean Territory': 'ğŸ‡®ğŸ‡´',
                'Christmas Island': 'ğŸ‡¨ğŸ‡½',
                'Cocos Islands': 'ğŸ‡¨ğŸ‡¨',
                'Norfolk Island': 'ğŸ‡³ğŸ‡«',
                'Pitcairn Islands': 'ğŸ‡µğŸ‡³',
                'Tokelau': 'ğŸ‡¹ğŸ‡°',
                'Niue': 'ğŸ‡³ğŸ‡º',
                'Cook Islands': 'ğŸ‡¨ğŸ‡°',
                'American Samoa': 'ğŸ‡¦ğŸ‡¸',
                'Guam': 'ğŸ‡¬ğŸ‡º',
                'Northern Mariana Islands': 'ğŸ‡²ğŸ‡µ',
                'Palau': 'ğŸ‡µğŸ‡¼',
                'Marshall Islands': 'ğŸ‡²ğŸ‡­',
                'Micronesia': 'ğŸ‡«ğŸ‡²',
                'Nauru': 'ğŸ‡³ğŸ‡·',
                'Kiribati': 'ğŸ‡°ğŸ‡®',
                'Tuvalu': 'ğŸ‡¹ğŸ‡»',
                'Vanuatu': 'ğŸ‡»ğŸ‡º',
                'New Caledonia': 'ğŸ‡³ğŸ‡¨',
                'Solomon Islands': 'ğŸ‡¸ğŸ‡§',
                'Samoa': 'ğŸ‡¼ğŸ‡¸',
                'Tonga': 'ğŸ‡¹ğŸ‡´',
                'Wallis and Futuna': 'ğŸ‡¼ğŸ‡«',
                'French Polynesia': 'ğŸ‡µğŸ‡«',
                'Easter Island': 'ğŸ‡¨ğŸ‡±',
                'GalÃ¡pagos Islands': 'ğŸ‡ªğŸ‡¨',
                'Cayman Islands': 'ğŸ‡°ğŸ‡¾',
                'Bermuda': 'ğŸ‡§ğŸ‡²',
                'Turks and Caicos Islands': 'ğŸ‡¹ğŸ‡¨',
                'British Virgin Islands': 'ğŸ‡»ğŸ‡¬',
                'U.S. Virgin Islands': 'ğŸ‡»ğŸ‡®',
                'Puerto Rico': 'ğŸ‡µğŸ‡·',
                'Anguilla': 'ğŸ‡¦ğŸ‡®',
                'Montserrat': 'ğŸ‡²ğŸ‡¸',
                'Saint Kitts and Nevis': 'ğŸ‡°ğŸ‡³',
                'Antigua and Barbuda': 'ğŸ‡¦ğŸ‡¬',
                'Dominica': 'ğŸ‡©ğŸ‡²',
                'Saint Lucia': 'ğŸ‡±ğŸ‡¨',
                'Saint Vincent and the Grenadines': 'ğŸ‡»ğŸ‡¨',
                'Grenada': 'ğŸ‡¬ğŸ‡©',
                'Barbados': 'ğŸ‡§ğŸ‡§',
                'Trinidad and Tobago': 'ğŸ‡¹ğŸ‡¹',
                'Aruba': 'ğŸ‡¦ğŸ‡¼',
                'CuraÃ§ao': 'ğŸ‡¨ğŸ‡¼',
                'Bonaire': 'ğŸ‡§ğŸ‡¶',
                'Sint Eustatius': 'ğŸ‡§ğŸ‡¶',
                'Saba': 'ğŸ‡§ğŸ‡¶',
                'Sint Maarten': 'ğŸ‡¸ğŸ‡½',
                'Saint Martin': 'ğŸ‡²ğŸ‡«',
                'Saint BarthÃ©lemy': 'ğŸ‡§ğŸ‡±',
                'Guadeloupe': 'ğŸ‡¬ğŸ‡µ',
                'Martinique': 'ğŸ‡²ğŸ‡¶',
                'Dominican Republic': 'ğŸ‡©ğŸ‡´',
                'Haiti': 'ğŸ‡­ğŸ‡¹',
                'Jamaica': 'ğŸ‡¯ğŸ‡²',
                'Cuba': 'ğŸ‡¨ğŸ‡º',
                'Bahamas': 'ğŸ‡§ğŸ‡¸',
                'Belize': 'ğŸ‡§ğŸ‡¿',
                'Guatemala': 'ğŸ‡¬ğŸ‡¹',
                'El Salvador': 'ğŸ‡¸ğŸ‡»',
                'Honduras': 'ğŸ‡­ğŸ‡³',
                'Nicaragua': 'ğŸ‡³ğŸ‡®',
                'Costa Rica': 'ğŸ‡¨ğŸ‡·',
                'Panama': 'ğŸ‡µğŸ‡¦',
                'æœ¬åœ°': 'ğŸ ',
                'æœ¬åœ°ç½‘ç»œ': 'ğŸ '
            };
            
            return flagMap[countryName] || 'ğŸŒ';
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('whitelist-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            try {
                const formData = {
                    company_name: document.getElementById('company-name').value.trim(),
                    token: document.getElementById('token').value.trim(),
                    ip_address: document.getElementById('ip-address').value.trim()
                };
                
                // åŸºæœ¬éªŒè¯
                if (!formData.company_name || !formData.token || !formData.ip_address) {
                    showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                    return;
                }
                
                // IPåœ°å€æ ¼å¼éªŒè¯
                if (!isValidIP(formData.ip_address)) {
                    showAlert('IPåœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„IPv4åœ°å€', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰IP
                if (isPrivateIP(formData.ip_address)) {
                    showAlert('æ£€æµ‹åˆ°ç§æœ‰IPåœ°å€ï¼Œè¯·ç¡®ä¿è¾“å…¥çš„æ˜¯æ‚¨çš„å…¬ç½‘IPåœ°å€', 'error');
                    return;
                }
                
                // å…ˆæ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
                console.log('æ­£åœ¨éªŒè¯token...');
                const tokenCheckResponse = await fetch(`${API_BASE}/public/validate-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ token: formData.token }),
                    signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
                });
                
                if (!tokenCheckResponse.ok) {
                    const errorText = await tokenCheckResponse.text();
                    console.error('TokenéªŒè¯å“åº”å†…å®¹:', errorText);
                    throw new Error(`TokenéªŒè¯å¤±è´¥: ${tokenCheckResponse.status} ${tokenCheckResponse.statusText}`);
                }
                
                const tokenResult = await tokenCheckResponse.json();
                console.log('TokenéªŒè¯ç»“æœ:', tokenResult);
                
                if (!tokenResult.valid) {
                    showAlert(`TokenéªŒè¯å¤±è´¥: ${tokenResult.message}`, 'error');
                    return;
                }
                
                if (tokenResult.auto_approve) {
                    // å¦‚æœtokenæ”¯æŒè‡ªåŠ¨å®¡æ‰¹ï¼Œç›´æ¥æ·»åŠ åˆ°ç™½åå•
                    console.log('Tokenæ”¯æŒè‡ªåŠ¨å®¡æ‰¹ï¼Œæ­£åœ¨è‡ªåŠ¨æ·»åŠ ...');
                    const autoApproveResponse = await fetch(`${API_BASE}/public/auto-approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify(formData),
                        signal: AbortSignal.timeout(15000) // 15ç§’è¶…æ—¶
                    });
                    
                    if (!autoApproveResponse.ok) {
                        const errorText = await autoApproveResponse.text();
                        console.error('è‡ªåŠ¨å®¡æ‰¹å“åº”å†…å®¹:', errorText);
                        throw new Error(`è‡ªåŠ¨å®¡æ‰¹å¤±è´¥: ${autoApproveResponse.status} ${autoApproveResponse.statusText}`);
                    }
                    
                    const autoResult = await autoApproveResponse.json();
                    console.log('è‡ªåŠ¨å®¡æ‰¹ç»“æœ:', autoResult);
                    
                    if (autoResult.success) {
                        showAlert(`
                            <strong>âœ… ç™½åå•æ·»åŠ æˆåŠŸï¼</strong><br>
                            IPåœ°å€: ${formData.ip_address}<br>
                            çŠ¶æ€: å·²è‡ªåŠ¨æ·»åŠ åˆ°ç™½åå•<br>
                            ç”³è¯·ID: ${autoResult.request_id}
                        `, 'success');
                        
                        document.getElementById('whitelist-form').reset();
                        document.getElementById('ip-address').value = formData.ip_address; // ä¿æŒIPåœ°å€
                    } else {
                        showAlert(`è‡ªåŠ¨æ·»åŠ å¤±è´¥: ${autoResult.message}`, 'error');
                    }
                } else {
                    // æ™®é€šç”³è¯·æµç¨‹
                    console.log('Tokenä¸æ”¯æŒè‡ªåŠ¨å®¡æ‰¹ï¼Œæäº¤ç”³è¯·...');
                    const response = await fetch(`${API_BASE}/public/request`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify(formData),
                        signal: AbortSignal.timeout(15000) // 15ç§’è¶…æ—¶
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('ç”³è¯·æäº¤å“åº”å†…å®¹:', errorText);
                        throw new Error(`ç”³è¯·æäº¤å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('ç”³è¯·æäº¤ç»“æœ:', result);
                    
                    if (result.success) {
                        showAlert(`
                            <strong>âœ… ç”³è¯·æäº¤æˆåŠŸï¼</strong><br>
                            ç”³è¯·ID: ${result.request_id}<br>
                            çŠ¶æ€: ç­‰å¾…å®¡æ ¸<br>
                            è¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸æ‚¨çš„ç”³è¯·
                        `, 'success');
                        
                        document.getElementById('whitelist-form').reset();
                        document.getElementById('ip-address').value = formData.ip_address; // ä¿æŒIPåœ°å€
                        
                    } else {
                        showAlert(`ç”³è¯·æäº¤å¤±è´¥: ${result.message}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('ç”³è¯·æäº¤å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                
                let errorMessage = 'ç”³è¯·æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                if (error.name === 'TimeoutError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.message.includes('AbortError')) {
                    errorMessage = 'è¯·æ±‚è¢«ä¸­æ–­ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('TokenéªŒè¯å¤±è´¥')) {
                    errorMessage = error.message;
                } else if (error.message.includes('ç”³è¯·æäº¤å¤±è´¥')) {
                    errorMessage = error.message;
                }
                
                showAlert(errorMessage, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤ç”³è¯·';
            }
        });


    </script>
</body>
</html>
